#协调器与定位器通信协议 V0.2
---
###概述
本文档定义pprt系统中，协调器与定位器之间的通信协议以及通信流程，供相关人员查阅。

###协议说明
1. 协调器与定位器之间使用串口进行通信。
2. 通信内容使用ASCII字符。
3. 发送方每次发送一条报文，收到合法应答报文之后才能发送另一条报文。
4. 在串口中发送报文时，每次最多发送128个字节，超过128字节的报文应该分条发送。
5. 报文以`[`作为起始字符，`]`作为结束字符，报文内以`,`分隔字段。
6. 报文第一个字段是流水号，应答报文应当与发送报文流水号相同，流水号的为2位16进制字符。
7. 报文最后一个字段是校验和。校验对象是除了`[]`及校验和自身之外的所有数据。
8. 发送方若发送报文后没有收到应答，应隔一段时间后重试。

###协议结构
协议基本结构如下：
>**[流水号，设备时间，命令字，参数，校验和]**
* **流水号**：两个16进制字符表示，发送方控制递增。
* **设备时间**：发送报文方当前时间，格式为yymmhhmmss。例如150528103910代表2015年5月28日10点39分10秒。
* **命令字**：具体的控制命令字。
* **参数**：命令携带的参数。
* **校验和**：校验对象是`[`与校验字段前`,`之间的所有字符(不包含`[`与`,`)，校验和由所有校验对象计算异或而成，校验和为2位16进制字符。

**发送报文必须包含协议结构中所有对象，应答报文的参数可以为空。**
示例：
发送报文 `[0A,150528103910,C1,1212121212,BC]`
应答报文 `[0A,150528103910,C1,,3D]`
###命令字及参数
**协调器至定位器**
1. 开机报文
协调器开机之后即上发此报文，收到T1回复进入工作状态之后才开始工作。
|命令字|参数|
|---|---|
|C1|uid;status;panid|
uid: 协调器唯一标识，8位16进制字符
status: 协调器上次工作状态,取值范围0/1, 0:init,1:work
panid: 协调器网络PANID,4位16进制字符
示例：`C1,3344AABB;0;FFEE`
2. 网络状态更新报文
协调器网络状态发生变化后发送此报文。
|命令字|参数|
|---|---|
|C2|total_num;cur_num;nid#sid#s_status#s_bat;...|
total_num: 该网络内所有节点数量，10进制字符。
cur_num:此次上报节点数量，10进制字符。
nid: 节点网络id，1~2位16进制字符，0x0~0xFF
sid: 节点唯一标识，8位16进制字符
s_status: 节点工作状态，取值范围0/1, 0:install,1:work
s_bat: 协调器存储的最新节点电池电压，精确到毫伏，4位10进制字符
示例：`C2,10;2;1A#567A9B33#0#4410;1B#657B9A44#1#4551`
3. 数据状态更新报文
协调器上报数据使用此报文。
|命令字|参数|
|---|---|
|C3,num;nid#sid#s_status#s_bat#time#x#y#z;...|
num: 本次上报数据个数，10进制字符
nid: 节点网络id，1~2位16进制字符，0x0~0xFF
sid: 节点唯一标识，8位16进制字符
s_bat: 节点电池电压，精确到毫伏，4位10进制字符
time：节点采集时间，格式ddhhmm
x,y,z: 节点采集数据及时间
示例：`C3,1;3955;2;1A#567A9B#0#4410#281005#1#2#3;1B#657B9A#1#4551#290505#3#2#1`
******
**定位器至协调器**
1. 协调器状态控制报文
控制协调器工作状态。
|命令字|参数|
|---|---|
|T1|status|
status: 协调器工作状态,取值范围0/1, 0:init,1:work
2. 节点控制报文
控制节点工作、网络状态、工作参数。
|命令字|参数|
|---|---|
|T2|nid;sid;n_status;s_status;count#type#time1#time2|
nid: 节点网络id，1~2位16进制字符，0x0~0xFF
sid: 节点唯一标识，8位16进制字符
n_status: 节点控制参数，取值范围0/1, 0:更新工作状态,1:删除节点
s_status: 节点工作状态，取值范围0/1, 0:install,1:work
count: 节点采集count次数据上报一次。
type: 参数配置类型，0/1，0：周期性上报，1：定时上报
time1：格式hhmm，如果类型为周期性上报，表示起始上报时间。如果为定时上报，表示每天定时上报时间。
time2：格式hhmm，如果类型为周期性上报，表示上报周期。如果为定时上报，则表示每天定时上报时间。
定时上报可以设置每天最多两个时间点，至少有一个时间点。
示例：
`T2,1A;34566543;1;;;`删除节点
`T2,1A;34566543;0;0;;`更改状态为install
`T2,1A;34566543;0;1;5#0#0100#0230`更改状态为work，采用周期上报，开始于下一次1点，采集周期2个半小时，5个点上报一次
`T2,1A;34566543;0;1;1#1#0100#0230`更改状态为work，采用每天定时上报，每天1点，2点半采集数据，1个点上报一次
3. 恢复出厂报文
清空协调器内部数据。
|命令字|参数|
|---|---|
|T3|无|
4. 网络状态查询报文
查询协调器整个网络状态。
|命令字|参数|
|---|---|
|T4|无|
